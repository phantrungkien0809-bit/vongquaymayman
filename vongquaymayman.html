<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√≤ng Quay May M·∫Øn</title>
    <style>
        :root {
            --brown-dark: #5d4037;
            --parchment: #fdf5e6;
            --gold-dark: #b8860b;
            --gold-light: #ffd700;
            --pink-light: #fce4ec;
            --pink-dark: #f8bbd0;
            --green-correct: #4CAF50;
            --orange-incorrect: #ff9800;
        }

        /* Basic Setup & Typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "Times New Roman", Times, serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        /* Background and Aspect Ratio Container */
        .game-container {
            width: 100vw;
            max-width: calc(100vh * 16 / 9);
            height: 100vh;
            max-height: calc(100vw * 9 / 16);
            position: relative;
            background-image: url('https://www.galeriemichael.com/wp-content/uploads/2025/06/hinh-nen-powerpoint_21.jpg');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            color: white;
        }

        /* Header */
        header {
            text-align: center;
            padding: 1.5vh 0;
            flex-shrink: 0;
        }

        header h1 {
            font-size: clamp(2rem, 5vh, 4rem);
            color: red;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            left: 2cm;
        }

        /* Main Content Area */
        main {
            display: flex;
            flex-grow: 1;
            padding: 1vh 2vw;
            gap: 2vw;
            height: calc(100% - 10vh); /* Adjust based on header height */
        }

        /* Left Panel */
        .left-panel {
            width: 22%;
            display: flex;
            flex-direction: column;
            gap: 2vh; /* Reduced gap */
        }

        .question-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 columns */
            grid-template-rows: 1fr 1fr 1fr; /* 3 rows */
            gap: 1.5vh;
            aspect-ratio: 1 / 1; /* Adjusted aspect ratio for 3x3 */
        }

        .question-box {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1.5rem, 4vh, 3rem);
            font-weight: bold;
            color: white;
            border-radius: 1.5vh;
            box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.3);
            border: 0.3vh solid rgba(255, 255, 255, 0.7);
            cursor: not-allowed;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .question-box.available {
            cursor: pointer;
            opacity: 1;
            animation: pulse 1.5s infinite;
        }

        .question-box.answered {
            cursor: not-allowed;
            opacity: 0.5;
            animation: none;
        }
        
        .question-box.answered::after {
            content: '‚úì';
            color: white;
            font-size: 1.2em;
            text-shadow: 0 0 10px #0f0;
        }

        .question-box.answered.incorrectly::after {
            content: '‚úó';
            color: #e53935;
            text-shadow: 0 0 5px white;
        }

        .question-box[data-q="1"] { background-color: #e53935; } /* red */
        .question-box[data-q="2"] { background-color: #1e88e5; } /* blue */
        .question-box[data-q="3"] { background-color: #43a047; } /* green */
        .question-box[data-q="4"] { background-color: #fdd835; color: #333; } /* yellow */
        .question-box[data-q="5"] { background-color: #8e24aa; } /* purple */
        .question-box[data-q="6"] { background-color: #fb8c00; } /* orange */
        .question-box[data-q="7"] { background-color: #00acc1; } /* cyan */
        .question-box[data-q="8"] { background-color: #ec407a; } /* pink */
        .question-box[data-q="9"] { background-color: #78909c; } /* blue grey */
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0.8vh 2vh rgba(255,255,255,0.7); }
            100% { transform: scale(1); box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.3); }
        }

        .treasure-box {
            background-color: var(--parchment);
            border: 0.5vh solid var(--brown-dark);
            border-radius: 2vh;
            padding: 2vh;
            color: var(--brown-dark);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .treasure-box h2 {
            text-align: center;
            font-size: clamp(1.2rem, 3vh, 2rem);
            margin-bottom: 2vh;
            border-bottom: 0.2vh solid var(--brown-dark);
            padding-bottom: 1vh;
        }

        .reward-slots {
            display: flex;
            flex-direction: column;
            gap: 1vh; /* Reduced gap */
            flex-grow: 1;
        }

        .reward-slot {
            background-color: rgba(255, 255, 255, 0.5);
            border: 0.2vh dashed var(--brown-dark);
            border-radius: 1vh;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px; /* Updated font size */
            font-weight: bold;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        
        .reward-slot.filled {
             background-color: var(--gold-light);
             border-style: solid;
             animation: reveal 0.5s ease-out;
        }
        
        .reward-slot.missed {
            background-color: #e0e0e0;
            border-style: solid;
            border-color: #9e9e9e;
            color: #757575;
        }

        .reward-slot.missed::after {
            content: '';
            position: absolute;
            display: block;
            width: 110%;
            height: 3px;
            background: var(--brown-dark);
            transform: rotate(-10deg);
        }

        @keyframes reveal {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Right Panel */
        .right-panel {
            width: 78%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wheel-container {
            width: 95%;
            height: auto;
            aspect-ratio: 1 / 1;
            position: relative;
        }
        
        #wheelCanvas {
            width: 100%;
            height: 100%;
        }

        .pointer {
            position: absolute;
            top: -2%; /* Adjust to point precisely at the rim */
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 3vh solid transparent;
            border-right: 3vh solid transparent;
            border-top: 5vh solid var(--brown-dark);
            z-index: 10;
            filter: drop-shadow(0 0.4vh 0.2vh rgba(0,0,0,0.5));
        }

        .spin-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20%;
            height: 20%;
            border-radius: 50%;
            background-image: radial-gradient(circle, var(--gold-light), var(--gold-dark));
            border: 0.8vh solid #daa520; /* Gold */
            box-shadow: inset 0 0 1vh rgba(255,255,255,0.8), 0 0.5vh 1vh rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--brown-dark);
            font-size: clamp(1.5rem, 5vh, 3rem);
            font-weight: bold;
            cursor: pointer;
            z-index: 5;
            transition: transform 0.2s ease;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        .spin-button:hover:not(:disabled) {
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        .spin-button:active:not(:disabled) {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .spin-button:disabled {
            cursor: not-allowed;
            filter: grayscale(80%);
        }

        #winnerDisplay {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 2vh 3vh;
            border-radius: 2.5vh;
            font-size: clamp(2rem, 6vh, 4rem);
            font-weight: bold;
            border: 0.4vh solid var(--gold-light);
            z-index: 11;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 2.5vh;
        }
        
        #winnerDisplay img {
            height: 18vh;
            width: 18vh;
            border-radius: 50%;
            border: 0.3vh solid var(--gold-light);
            background-color: #fff;
        }

        #winnerDisplay.show {
            opacity: 1;
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 1vh #fff, 0 0 2vh #fff, 0 0 3vh var(--gold-light), 0 0 4vh var(--gold-light);
                text-shadow: 0 0 0.5vh #fff, 0 0 1vh var(--gold-light);
            }
            to {
                box-shadow: 0 0 2vh #fff, 0 0 3vh #fff, 0 0 4vh var(--gold-light), 0 0 5vh var(--gold-light);
                text-shadow: 0 0 1vh #fff, 0 0 1.5vh var(--gold-light);
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--parchment);
            color: var(--brown-dark);
            padding: 4vh;
            border-radius: 2vh;
            border: 0.8vh solid var(--gold-dark);
            width: 90%; /* Increased size */
            max-width: 1100px; /* Increased size */
            text-align: center;
            transform: scale(0.7);
            transition: transform 0.3s ease;
            font-family: "Times New Roman", Times, serif; /* Ensured font */
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2vw;
            margin-bottom: 3vh;
        }

        .modal-header img {
            width: 10vh;
            height: 10vh;
            border-radius: 50%;
            border: 0.4vh solid var(--brown-dark);
            background-color: #fff;
        }

        .modal-header h3 {
            font-size: clamp(1.5rem, 4vh, 2.5rem);
        }

        .question-text {
            font-size: 24px; /* Updated font size */
            margin-bottom: 4vh;
            font-weight: bold;
        }

        .answer-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2vh;
        }

        .answer-btn {
            background-color: var(--pink-light); /* Light pink background */
            color: var(--brown-dark);
            border: 0.3vh solid var(--brown-dark);
            border-radius: 1vh;
            padding: 2vh;
            font-size: 24px; /* Updated font size */
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: "Times New Roman", Times, serif;
            text-align: left;
        }

        .answer-btn:hover:not(:disabled) {
            background-color: var(--pink-dark);
        }

        .answer-btn.incorrect {
            background-color: var(--orange-incorrect); /* Orange for incorrect */
            color: white;
            border-color: white;
        }
        
        .answer-btn.correct {
            background-color: var(--green-correct); /* Green for correct */
            color: white;
            border-color: white;
        }

        .modal-footer {
            margin-top: 4vh;
            height: 5vh; /* Reserve space to prevent layout shift */
        }

        .next-turn-btn {
            background-color: #1e88e5; /* blue */
            color: white;
            border: none;
            border-radius: 1vh;
            padding: 1.5vh 4vh;
            font-size: clamp(1.2rem, 3vh, 2rem);
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        
        /* Fireworks */
        .fireworks-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 101;
        }
        
        .firework {
            position: absolute;
            width: 0.5vh;
            height: 0.5vh;
            border-radius: 50%;
        }

        /* End Screen */
        #endScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 200;
            display: none; /* Initially hidden */
        }

        #endVideo {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Mini Video Player */
        .mini-video-player {
            position: absolute;
            bottom: 2vh;
            right: 2vh;
            width: 25vw; /* Responsive width */
            max-width: 200px; /* Max width for larger screens */
            aspect-ratio: 16 / 9;
            border: 0.5vh solid var(--brown-dark);
            border-radius: 1vh;
            overflow: hidden;
            box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.5);
            z-index: 50; /* Above game elements, below modals */
        }

        #miniVideoPlayer {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <audio id="clappingSound" src="https://soundbible.com/mp3/SMALL_CROWD_APPLAUSE-Yannick_Lemieux-1268806408.mp3" preload="auto"></audio>

    <div class="game-container">
        <header>
            <h1>V√íNG QUAY MAY M·∫ÆN</h1>
        </header>

        <main>
            <div class="left-panel">
                <div class="question-selectors">
                    <div class="question-box" data-q="1">1</div>
                    <div class="question-box" data-q="2">2</div>
                    <div class="question-box" data-q="3">3</div>
                    <div class="question-box" data-q="4">4</div>
                    <div class="question-box" data-q="5">5</div>
                    <div class="question-box" data-q="6">6</div>
                    <div class="question-box" data-q="7">7</div>
                    <div class="question-box" data-q="8">8</div>
                    <div class="question-box" data-q="9">9</div>
                </div>
                <div class="treasure-box">
                    <h2>üéÅ H·ªòP KHO B√ÅU</h2>
                    <div class="reward-slots">
                        <div class="reward-slot" id="reward1"></div>
                        <div class="reward-slot" id="reward2"></div>
                        <div class="reward-slot" id="reward3"></div>
                        <div class="reward-slot" id="reward4"></div>
                        <div class="reward-slot" id="reward5"></div>
                        <div class="reward-slot" id="reward6"></div>
                        <div class="reward-slot" id="reward7"></div>
                        <div class="reward-slot" id="reward8"></div>
                        <div class="reward-slot" id="reward9"></div>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div class="pointer"></div>
                <div class="wheel-container">
                    <canvas id="wheelCanvas"></canvas>
                    <button class="spin-button" id="spinBtn">QUAY</button>
                </div>
                <div id="winnerDisplay"></div>
            </div>
        </main>

        <div class="mini-video-player">
            <div id="miniVideoPlayer"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <img id="studentAvatar" src="" alt="Avatar h·ªçc sinh">
                <h3 id="studentName"></h3>
            </div>
            <p class="question-text" id="questionText"></p>
            <div class="answer-options" id="answerOptions"></div>
            <div class="modal-footer">
                <button class="next-turn-btn" id="nextTurnBtn">L∆∞·ª£t ti·∫øp theo</button>
            </div>
        </div>
    </div>
    
    <div id="endScreen">
        <div id="endVideo"></div>
    </div>

    <div class="fireworks-container" id="fireworksContainer"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- YOUTUBE PLAYER VARIABLES ---
        let miniPlayer;
        let endPlayer;

        // This function creates an <iframe> (and YouTube player)
        // after the API code downloads.
        function onYouTubeIframeAPIReady() {
            miniPlayer = new YT.Player('miniVideoPlayer', {
                height: '100%',
                width: '100%',
                videoId: 'PTuQC3H6gtI',
                playerVars: {
                    'playsinline': 1,
                    'autoplay': 0, // Will be controlled by script
                    'controls': 0,
                    'loop': 1,
                    'mute': 0,
                    'playlist': 'PTuQC3H6gtI' // Required for loop to work
                }
            });

            endPlayer = new YT.Player('endVideo', {
                height: '100%',
                width: '100%',
                videoId: 'i4J1YCsBSBg',
                playerVars: {
                    'playsinline': 1,
                    'autoplay': 0, // Will be controlled by script
                    'controls': 0,
                    'loop': 1,
                    'mute': 0,
                    'playlist': 'i4J1YCsBSBg' // Required for loop to work
                }
            });
        }

        // --- GAME DATA ---
        const STUDENTS = [
            'Danh', 'ƒê·∫°t', 'ƒê·ª©c', 'H·∫±ng', 'H√¢n', 'Hi·∫øu', 'Ho√†ng', 'Huy', 'H∆∞∆°ng', 'Q.H∆∞∆°ng', 
            'Khang', 'Kh∆∞∆°ng', 'Kim', 'Lam', 'L√¢m', 'H.Long', 'M.Long', 'Ng√¢n', 'Nguy√™n', 
            'Nguy·ªát', 'Nhi', 'N·ªØ', 'Ny', 'B.Ph∆∞∆°ng', 'Ph∆∞∆°ng', 'Quy√™n', 'Qu√Ω', 'T.Th·∫£o', 
            'P.Th·∫£o', 'Thi·ªán', 'Th·ªç', 'Thuyt', 'Trang', 'Tr√¢n', 'Yi'
        ];
        
        const FEMALE_NAMES = [
            'H·∫±ng', 'H√¢n', 'H∆∞∆°ng', 'Q.H∆∞∆°ng', 'Kim', 'Lam', 'Ng√¢n', 'Nguy·ªát', 'Nhi', 'N·ªØ', 'Ny', 
            'B.Ph∆∞∆°ng', 'Ph∆∞∆°ng', 'Quy√™n', 'T.Th·∫£o', 'P.Th·∫£o', 'Trang', 'Tr√¢n', 'Yi'
        ];
        const AVATARS = {
            male: 'https://png.pngtree.com/png-clipart/20250609/original/pngtree-3d-cartoon-young-student-on-with-white-background-png-image_21148718.png',
            female: 'https://png.pngtree.com/png-vector/20240721/ourlarge/pngtree-cute-girl-going-to-school-cartoon-vector-icon-illustration-png-image_13176137.png'
        };

        const QUESTIONS = [
            {
                question: "Ph√≥ t·ª´ l√† g√¨?",
                answer: "A. L√† nh·ªØng t·ª´ chuy√™n ƒëi k√®m v·ªõi danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´ ƒë·ªÉ b·ªï sung √Ω nghƒ©a cho danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´.",
                options: [
                    "A. L√† nh·ªØng t·ª´ chuy√™n ƒëi k√®m v·ªõi danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´ ƒë·ªÉ b·ªï sung √Ω nghƒ©a cho danh t·ª´, ƒë·ªông t·ª´, t√≠nh t·ª´.",
                    "B. L√† nh·ªØng t·ª´ chuy√™n ƒëi k√®m ph·ª• sau danh t·ª´, b·ªï sung √Ω nghƒ©a cho danh t·ª´.",
                    "C. L√† nh·ªØng t·ª´ c√≥ ch·ª©c nƒÉng nh∆∞ th√†nh ph·∫ßn trung t√¢m c·ªßa c·ª•m t·ª´ danh t·ª´.",
                    "D. Kh√¥ng x√°c ƒë·ªãnh."
                ]
            },
            {
                question: "Ph√≥ t·ª´ g·ªìm m·∫•y nh√≥m?",
                answer: "A. 2 nh√≥m.",
                options: ["A. 2 nh√≥m.", "B. 3 nh√≥m.", "C. 4 nh√≥m.", "D. 5 nh√≥m."]
            },
            {
                question: "T√¨m ph√≥ t·ª´ trong c√¢u: ‚ÄúNh·ªØng l√∫c ·∫•y, th·∫ßy ƒêuy-sen ƒë√£ b·∫ø c√°c em qua n√∫i‚Äù. (Ng∆∞·ªùi th·∫ßy ƒë·∫ßu ti√™n)",
                answer: "B. Nh·ªØng, ƒë√£, c√°c",
                options: ["A. Nh·ªØng, ·∫•y, qua", "B. Nh·ªØng, ƒë√£, c√°c", "C. Nh·ªØng, l√∫c, c√°c", "D. Kh√¥ng c√≥ ph√≥ t·ª´"]
            },
            {
                question: "T√¨m ph√≥ t·ª´ trong c√¢u: ‚ÄúM·∫•y ng√†y m∆∞a li√™n mi√™n v√† n∆∞·ªõc s√¥ng d√¢ng l√™n r·∫•t nhanh.‚Äù (B·∫ßy chim ch√¨a v√¥i - Nguy·ªÖn Quang Thi·ªÅu)",
                answer: "B. M·∫•y, l√™n, r·∫•t",
                options: ["A. M·∫•y, v√†, nhanh", "B. M·∫•y, l√™n, r·∫•t", "C. M·∫•y, nhanh, l√™n", "D. M·∫•y, n∆∞·ªõc, l√™n"]
            },
            {
                question: "C√¢u n√†o d∆∞·ªõi ƒë√¢y c√≥ s·ª≠ d·ª•ng ph√≥ t·ª´?",
                answer: "D. M√πa h√® s·∫Øp ƒë·∫øn g·∫ßn.",
                options: ["A. M·∫∑t em b√© tr√≤n nh∆∞ trƒÉng r·∫±m.", "B. Da ch·ªã ·∫•y m·ªãn nh∆∞ nhung.", "C. Ch√¢n anh ta d√†i l√™u ngh√™u.", "D. M√πa h√® s·∫Øp ƒë·∫øn g·∫ßn."]
            },
            {
                question: "C√¢u n√†o d∆∞·ªõi ƒë√¢y c√≥ s·ª≠ d·ª•ng ph√≥ t·ª´?",
                answer: "C. T√¥i s·∫Ω c·ªë g·∫Øng h·ªçc th·∫≠t t·ªët.",
                options: ["A. T√¥i c·ªë g·∫Øng h·ªçc t·ªët.", "B. T√¥i h·ªçc t·ªët.", "C. T√¥i s·∫Ω c·ªë g·∫Øng h·ªçc th·∫≠t t·ªët.", "D. T√¥i c·ªë g·∫Øng h·ªçc."]
            },
            {
                question: "Trong c√¢u vƒÉn sau: ‚ÄúB·∫°n A ƒë√° b√≥ng hay qu√°.‚Äù Ph√≥ t·ª´ ‚Äúqu√°‚Äù ƒë·ª©ng sau t√≠nh t·ª´ ‚Äúhay‚Äù b·ªï sung √Ω nghƒ©a g√¨?",
                answer: "D. Ch·ªâ m·ª©c ƒë·ªô",
                options: ["A. Ch·ªâ s·ª± c·∫ßu khi·∫øn", "B. Ch·ªâ k·∫øt qu·∫£ v√† h∆∞·ªõng", "C. Ch·ªâ quan h·ªá th·ªùi gian", "D. Ch·ªâ m·ª©c ƒë·ªô"]
            },
            {
                question: "Em h√£y ƒë·∫∑t c√¢u v·ªõi ph√≥ t·ª´ ‚Äúƒë√£‚Äù.",
                answer: null, // D√πng null ho·∫∑c m·∫£ng r·ªóng ƒë·ªÉ x√°c ƒë·ªãnh ƒë√¢y l√† c√¢u t·ª± lu·∫≠n
                options: []
            },
            {
                question: "Em h√£y ƒë·∫∑t c√¢u v·ªõi ph√≥ t·ª´ ‚Äúƒë∆∞·ª£c‚Äù.",
                answer: null,
                options: []
            }
        ];
        const REWARDS = [
            'üíØ 10 ƒêi·ªÉm',
            'üëè Tr√†ng V·ªó Tay',
            '‚ûï ƒêi·ªÉm C·ªông',
            '‚úèÔ∏è C√¢y B√∫t Xinh',
            'üåü Ng√¥i Sao May M·∫Øn',
            'üç¨ K·∫πo Ng·ªçt',
            'üéÅ H·ªôp Qu√† B√≠ ·∫®n',
            'üíñ Th·∫£ Tim',
            'üéâ Ph√°o Hoa'
        ];

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const winnerDisplay = document.getElementById('winnerDisplay');
        const questionModal = document.getElementById('questionModal');
        const nextTurnBtn = document.getElementById('nextTurnBtn');
        const questionBoxes = document.querySelectorAll('.question-box');
        const rewardSlots = document.querySelectorAll('.reward-slot');
        const endScreen = document.getElementById('endScreen');
        const clappingSound = document.getElementById('clappingSound');

        // --- GAME STATE ---
        let segments = [];
        let currentRotation = 0;
        let isSpinning = false;
        let currentTurn = 0;
        let currentWinner = null;
        let questionsAnswered = [];
        const guaranteedWinners = ['Danh', 'H·∫±ng']; // Danh s√°ch h·ªçc sinh ch·∫Øc ch·∫Øn tr√∫ng th∆∞·ªüng

        // State for new spin animation
        let targetRotation = 0;
        let spinStartTime;
        let startRotation;
        const spinDuration = 8000; // 8 gi√¢y cho m·ªói v√≤ng quay

        // --- SPEECH SYNTHESIS ---
        function speak(text) {
            window.speechSynthesis.cancel();
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.rate = 1.1; // TƒÉng t·ªëc ƒë·ªô gi·ªçng n√≥i
                window.speechSynthesis.speak(utterance);
            } else {
                console.log("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Text-to-Speech.");
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        // --- WHEEL DRAWING LOGIC ---
        const segmentColors = ['#f44336', '#e91e63', '#9c27B0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b', '#f48fb1', '#ce93d8', '#b39ddb', '#9fa8da', '#81d4fa', '#80cbc4', '#a5d6a7'];

        function setupWheel() {
            const shuffledStudents = shuffleArray([...STUDENTS]);
            segments = shuffledStudents.map((name, index) => ({
                text: name,
                color: segmentColors[index % segmentColors.length]
            }));
            drawWheel();
        }

        function drawWheel() {
            const numSegments = segments.length;
            const anglePerSegment = (2 * Math.PI) / numSegments;
            const size = canvas.width;
            const center = size / 2;
            const radius = size * 0.36;
            
            ctx.clearRect(0, 0, size, size);
            ctx.save();
            ctx.translate(center, center);
            ctx.rotate(currentRotation);

            for (let i = 0; i < numSegments; i++) {
                const segment = segments[i];
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, i * anglePerSegment, (i + 1) * anglePerSegment);
                ctx.closePath();
                ctx.fillStyle = segment.color;
                ctx.fill();
            }
            
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = size * 0.02;
            ctx.stroke();

            for (let i = 0; i < numSegments; i++) {
                const segment = segments[i];
                const angle = (i + 0.5) * anglePerSegment;
                
                ctx.save();
                ctx.rotate(angle);
                
                ctx.fillStyle = 'white';
                ctx.font = `bold 16px "Times New Roman"`; // Gi·∫£m k√≠ch th∆∞·ªõc font m·ªôt ch√∫t
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                if (angle > Math.PI / 2 && angle < (3 * Math.PI) / 2) {
                    ctx.rotate(Math.PI);
                    ctx.fillText(segment.text, -radius * 0.75, 0);
                } else {
                    ctx.fillText(segment.text, radius * 0.75, 0);
                }
                ctx.restore();
            }
            ctx.restore();
        }

        // --- SPINNING LOGIC ---
        function easeOutQuint(t) {
            return 1 + (--t) * t * t * t * t;
        }

        function spinLoop() {
            if (!isSpinning) return;
            const elapsedTime = Date.now() - spinStartTime;
            const progress = Math.min(elapsedTime / spinDuration, 1);
            const easedProgress = easeOutQuint(progress);
            currentRotation = startRotation + (targetRotation - startRotation) * easedProgress;
            drawWheel();
            if (progress < 1) {
                requestAnimationFrame(spinLoop);
            } else {
                isSpinning = false;
                currentRotation = targetRotation % (2 * Math.PI); 
                determineWinner();
            }
        }

        function startSpin() {
            if (isSpinning) return;
            if (miniPlayer && typeof miniPlayer.playVideo === 'function') {
                miniPlayer.playVideo();
            }
            isSpinning = true;
            spinBtn.disabled = true;
            winnerDisplay.classList.remove('show');
            prepareAndRunSpin();
        }

        function prepareAndRunSpin() {
            let winnerIndex;

            // Ki·ªÉm tra xem c√≥ h·ªçc sinh ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh cho l∆∞·ª£t n√†y kh√¥ng
            if (currentTurn < guaranteedWinners.length) {
                const winnerName = guaranteedWinners[currentTurn];
                winnerIndex = segments.findIndex(segment => segment.text === winnerName);
                
                // N·∫øu kh√¥ng t√¨m th·∫•y (tr∆∞·ªùng h·ª£p hi·∫øm), ch·ªçn ng·∫´u nhi√™n
                if (winnerIndex === -1) {
                    console.warn(`H·ªçc sinh ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh "${winnerName}" kh√¥ng c√≥ tr√™n v√≤ng quay. Ch·ªçn ng·∫´u nhi√™n.`);
                    winnerIndex = Math.floor(Math.random() * segments.length);
                }
            } else {
                // N·∫øu kh√¥ng, ch·ªçn ng·∫´u nhi√™n
                winnerIndex = Math.floor(Math.random() * segments.length);
            }
            currentWinner = segments[winnerIndex];
            const numSegments = segments.length;
            const anglePerSegment = (2 * Math.PI) / numSegments;
            const winnerAngle = (winnerIndex + 0.5) * anglePerSegment;
            let stoppingAngle = (1.5 * Math.PI) - winnerAngle;
            stoppingAngle = (stoppingAngle % (2 * Math.PI) + (2 * Math.PI)) % (2 * Math.PI);
            const fullRotations = 4 * (2 * Math.PI);
            let normalizedCurrent = currentRotation % (2 * Math.PI);
            normalizedCurrent = (normalizedCurrent + (2 * Math.PI)) % (2 * Math.PI);
            let distanceToStop = stoppingAngle - normalizedCurrent;
            if (distanceToStop < 0) {
                distanceToStop += (2 * Math.PI);
            }
            const spinAmount = fullRotations + distanceToStop;
            startRotation = currentRotation;
            targetRotation = currentRotation + spinAmount;
            spinStartTime = Date.now();
            spinLoop();
        }
        
        function determineWinner() {
            winnerDisplay.innerHTML = ''; // Clear previous content

            const isFemale = FEMALE_NAMES.includes(currentWinner.text);
            const avatarSrc = isFemale ? AVATARS.female : AVATARS.male;

            const avatarImg = document.createElement('img');
            avatarImg.src = avatarSrc;
            avatarImg.alt = "Avatar";

            const nameSpan = document.createElement('span');
            nameSpan.textContent = currentWinner.text;

            winnerDisplay.appendChild(avatarImg);
            winnerDisplay.appendChild(nameSpan);

            winnerDisplay.classList.add('show');

            if (miniPlayer && typeof miniPlayer.pauseVideo === 'function') {
                miniPlayer.pauseVideo();
            }
            
            speak(`M·ªùi em ${currentWinner.text} ch·ªçn m·ªôt c√¢u h·ªèi.`);
            
            setTimeout(activateQuestionBoxes, 1500);
        }

        // --- QUESTION & GAME FLOW LOGIC ---
        const selectQuestionHandler = (event) => {
            const selectedBox = event.currentTarget;
            const qNum = parseInt(selectedBox.dataset.q);
            deactivateQuestionBoxes();
            const questionData = QUESTIONS[qNum - 1];
            presentQuestion(questionData, qNum);
        };

        function activateQuestionBoxes() {
            questionBoxes.forEach(box => {
                const qNum = parseInt(box.dataset.q);
                if (!questionsAnswered.includes(qNum)) {
                    box.classList.add('available');
                    box.addEventListener('click', selectQuestionHandler);
                }
            });
        }

        function deactivateQuestionBoxes() {
            questionBoxes.forEach(box => {
                box.classList.remove('available');
                box.removeEventListener('click', selectQuestionHandler);
            });
        }

        function presentQuestion(questionData, originalQIndex) {
            if (!questionData) {
                console.error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c√¢u h·ªèi.");
                return;
            }
            const isFemale = FEMALE_NAMES.includes(currentWinner.text);
            document.getElementById('studentAvatar').src = isFemale ? AVATARS.female : AVATARS.male;
            document.getElementById('studentName').textContent = currentWinner.text;
            document.getElementById('questionText').innerHTML = `C√¢u h·ªèi: ${questionData.question}`;
            const answerContainer = document.getElementById('answerOptions');
            answerContainer.innerHTML = '';
            answerContainer.style.gridTemplateColumns = '1fr 1fr'; // Reset grid columns

            if (questionData.options && questionData.options.length > 0) {
                const shuffledOptions = shuffleArray([...questionData.options]);
                const optionPrefix = ['A.', 'B.', 'C.', 'D.'];
                shuffledOptions.forEach((option, i) => {
                    const btn = document.createElement('button');
                    btn.classList.add('answer-btn');
                    btn.innerHTML = `<strong>${optionPrefix[i]}</strong> ${option.substring(option.indexOf('.') + 1)}`; // Ch·ªâ l·∫•y n·ªôi dung sau A./B./...
                    btn.onclick = () => checkAnswer(btn, option, questionData.answer, originalQIndex);
                    answerContainer.appendChild(btn);
                });
            } else {
                // X·ª≠ l√Ω c√¢u h·ªèi t·ª± lu·∫≠n (Q8, Q9)
                answerContainer.style.gridTemplateColumns = '1fr'; // 1 c·ªôt cho n√∫t x√°c nh·∫≠n
                const btn = document.createElement('button');
                btn.classList.add('answer-btn');
                btn.style.backgroundColor = 'var(--green-correct)';
                btn.style.color = 'white';
                btn.style.textAlign = 'center';
                btn.innerHTML = `<strong>X√ÅC NH·∫¨N ƒê√É TR·∫¢ L·ªúI</strong>`;
                btn.onclick = () => handleOpenEndedAnswer(btn, originalQIndex);
                answerContainer.appendChild(btn);
            }
            questionModal.classList.add('show');
        }

        // H√†m m·ªõi ƒë·ªÉ x·ª≠ l√Ω c√¢u tr·∫£ l·ªùi t·ª± lu·∫≠n
        function handleOpenEndedAnswer(button, originalQIndex) {
            button.disabled = true;
            const qBox = document.querySelector(`.question-box[data-q="${originalQIndex}"]`);
            
            clappingSound.currentTime = 0;
            const playPromise = clappingSound.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Kh√¥ng th·ªÉ ph√°t √¢m thanh v·ªó tay:", error);
                });
            }
            
            speak("T·ªët l·∫Øm!");
            launchFireworks();
            button.classList.add('correct'); // Visual feedback
            qBox.classList.add('answered');
            qBox.innerHTML = ''; 
            questionsAnswered.push(originalQIndex);
            
            const rewardSlot = document.getElementById(`reward${currentTurn + 1}`);
            if(rewardSlot) {
                rewardSlot.textContent = REWARDS[currentTurn];
                rewardSlot.classList.add('filled');
            }
            currentTurn++;
            
            nextTurnBtn.style.display = 'inline-block';
        }
        
        function checkAnswer(button, selectedAnswer, correctAnswer, originalQIndex) {
            const allButtons = document.querySelectorAll('.answer-btn');
            allButtons.forEach(btn => btn.disabled = true);
            const qBox = document.querySelector(`.question-box[data-q="${originalQIndex}"]`);
            
            if (selectedAnswer === correctAnswer) {
                clappingSound.currentTime = 0;
                const playPromise = clappingSound.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Kh√¥ng th·ªÉ ph√°t √¢m thanh v·ªó tay:", error);
                    });
                }
                speak("ƒê√∫ng r·ªìi, ch√∫c m·ª´ng em");
                launchFireworks();
                button.classList.add('correct');
                qBox.classList.add('answered');
                qBox.innerHTML = ''; 
                questionsAnswered.push(originalQIndex);
                const rewardSlot = document.getElementById(`reward${currentTurn + 1}`);
                if(rewardSlot) {
                    rewardSlot.textContent = REWARDS[currentTurn];
                    rewardSlot.classList.add('filled');
                }
                currentTurn++;
            } else {
                speak("R·∫•t ti·∫øc, sai r·ªìi");
                button.classList.add('incorrect');
                allButtons.forEach(btn => {
                    if (btn.innerText.includes(correctAnswer.substring(correctAnswer.indexOf('.') + 1))) { // So s√°nh n·ªôi dung
                        btn.classList.add('correct');
                    }
                });
                qBox.classList.add('answered', 'incorrectly');
                qBox.innerHTML = '';
                questionsAnswered.push(originalQIndex);
                const rewardSlot = document.getElementById(`reward${currentTurn + 1}`);
                if(rewardSlot) {
                    rewardSlot.classList.add('missed');
                }
                currentTurn++;
            }
            nextTurnBtn.style.display = 'inline-block';
        }
        
        function handleNextTurn() {
            questionModal.classList.remove('show');
            nextTurnBtn.style.display = 'none';
            winnerDisplay.classList.remove('show');
            if (currentTurn >= 9) { // Thay 6 b·∫±ng 9
                setTimeout(() => {
                    endScreen.style.display = 'block';
                    if (endPlayer && typeof endPlayer.playVideo === 'function') {
                        endPlayer.playVideo();
                    }
                }, 1500);
            } else {
                spinBtn.disabled = false;
            }
        }

        // --- VISUAL EFFECTS ---
        function launchFireworks() {
            const container = document.getElementById('fireworksContainer');
            for (let i = 0; i < 30; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                firework.style.backgroundColor = color;
                const x = 50 + (Math.random() - 0.5) * 50;
                const y = 50 + (Math.random() - 0.5) * 50;
                firework.style.left = `${x}vw`;
                firework.style.top = `${y}vh`;
                container.appendChild(firework);
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 200 + 50;
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                firework.animate([
                    { transform: 'scale(1)', opacity: 1 },
                    { transform: `translate(${dx}px, ${dy}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 1000,
                    easing: 'ease-out'
                });
                setTimeout(() => firework.remove(), 1000);
            }
        }

        // --- INITIALIZATION ---
        function init() {
            const container = document.querySelector('.wheel-container');
            const size = Math.min(container.clientWidth, container.clientHeight);
            canvas.width = size;
            canvas.height = size;
            setupWheel();
            spinBtn.addEventListener('click', startSpin);
            nextTurnBtn.addEventListener('click', handleNextTurn);
        }
        
        // Handle responsive canvas
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const container = document.querySelector('.wheel-container');
                const size = container.clientWidth;
                canvas.width = size;
                canvas.height = size;
                drawWheel();
            }, 100);
        });

        window.onload = init;
    </script>
</body>
</html>